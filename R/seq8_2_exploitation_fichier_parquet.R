# Paramétrage ---------------------------------------
DPT <- c("08", "10", "51", "52", "54", "55",
         "57", "67", "68", "88")

# Établir la connexion au fichier Parquet partitionné ----
donnees_dvf_part <- open_dataset(
  PATH_DVF,
  partitioning = arrow::schema(coddep = arrow::utf8())
)

# Définir la requête
requete_dvf <- donnees_dvf_part %>%
  filter(coddep %in% DPT)  # Ici, on filtre selon la clé de partitionnement

# Récupérer le résultat sous forme d'un data.frame ----
dvf_GE <- requete_dvf %>% collect()

# Optimisation de la consommation de mémoire ----

dvf_GE_mut <- dvf_GE %>%
  # seulement les colonnes utiles
  select(idmutation, idnatmut, libnatmut, # id et nature mutation
         anneemut, moismut, # date
         codcomm, coddep, # localisation
         nbpar, # nombre de parcelles concernées par la transaction
         valeurfonc # valeur foncière
         ) %>% 
  # retirer les doublons / lignes inutiles
  distinct() %>% 
  # transformation en facteur des variables qui s'y prêtent
  mutate(across(c(libnatmut, codcomm), as.factor))

dvf_GE_mut %>% glimpse()

list_compare_objects <- list(df = dvf_GE, df_opti = dvf_GE_mut)

map(list_compare_objects,
    compare_size)

